<draggable-options field="form.sO" form="form" class="field-options" ng-if="form.e && form.poppedOut && form.sO.o"></draggable-options>
<div ng-form="myForm">

  <div class="col-xs-12 paper" ng-class="{'gridline-workspace':form.e}" ng-show="form.sections">
    <small class="col-xs-12">
      <span ng-if="report.viewing">{{report.title}}</span>
      <span ng-if="form.draft && !form.e">Draft</span>
    </small>


    <div ng-if="!form.e" class="col-xs-10 col-xs-offset-1 col-md-8 col-md-offset-2">
      <h1><center>{{form.name}}</center></h1>
    </div>


    <div class="section-row stay-open clearfix" ng-class="{'col-md-6 col-md-offset-3':section.c==1,'col-md-8 col-md-offset-2':section.c==2,'col-md-12':section.c==3}" ng-repeat="section in form.sections track by $index">
    <!-- ng-class="{'stay-open':!form.fields.length || form.sO.section_id == section_id+1 || form.sO == section_id}" -->

      <h2 ng-class="{'no-highlight':!form.e,'force-hover':form.sO==section,'field-hover':form.sO.section_id == section.i}" scroll-to=".force-hover" template="form">
        {{(!form.e && section.n) || null}}
        <input type="text" id="form-name" class="form-control imod" placeholder="Section name or blank" ng-if="form.e" ng-model="section.n" ng-click="form.sO=section" />
      </h2>

      <div class="section-layout" ng-if="form.e">
        <span class="col-xs-12">
          Reorder
          <a href="javascript:;" class="btn" ng-click="form.moveSection($index, $index-1)" scroll-to=".force-hover" template="form"><i class="glyphicon glyphicon-arrow-up"></i></a>
          <a href="javascript:;" class="btn" ng-click="form.moveSection($index, $index+1)" scroll-to=".force-hover" template="form"><i class="glyphicon glyphicon-arrow-down"></i></a>
          <div class="pull-right">
            <a href="javascript:;" class="btn" ng-if="section.c > 1" ng-click="form.deleteSectionColumn(section)"><i class="glyphicon glyphicon-minus"></i></a>
            <a href="javascript:;" class="btn" ng-if="section.c < 3" ng-click="form.addSectionColumn(section)"><i class="glyphicon glyphicon-plus"></i></a>
            Column
            <i class="glyphicon glyphicon-chevron-down"></i> &nbsp;
            <a href="javascript:;" class="btn btn-danger" ng-bootbox-confirm="<center><h4>Are you sure you want to remove this section from the page?<br><br>The section's columns and fields will also be deleted and this is not reversible.</h4></center>" ng-bootbox-confirm-action="form.deleteSection(section.i, myForm.$$parentForm)">Delete</a>
          </div>

        </span>
      </div>

      <div class="col-xs-12 column" ng-class="{'col-md-6':section.c == 2, 'col-md-4':section.c == 3}" ng-repeat="column in columnsArray(section.c) track by $index">
        <div ng-repeat="field in form.fields | filter:{o:{column_id: $index+1, section_id: section.i}} | orderBy:'o.column_order'">
          <template-field-directive ng-click="form.sO=field" myForm="myForm" field="field" template="form" report="report"></template-field-directive>

          <draggable-options field="field" form="form" class="field-options" ng-if="form.e && !form.poppedOut && form.sO==field"></draggable-options>
        </div>

        <div class="add-field-slide" ng-if="form.e && form.activeFields() < 20">
          <h4 class="col-xs-12">
            <i class="glyphicon glyphicon-chevron-up"></i> 
            <strong>New Field</strong> <small>{{section.n || 'Section '+(section.i)}}, Column {{$index+1}}</small>
          </h4>
          <div class="col-xs-12 col-md-4">
            <input type="text" class="form-control" placeholder="Name" ng-model="form.newFieldName">
            <input type="text" class="form-control" placeholder="Placeholder" ng-model="form.newFieldPlaceholder">
            <input type="text" class="form-control" placeholder="Default Value" ng-model="form.newFieldDefaultValue">
            <small>&nbsp; At least 1 required</small>
          </div>
          <div class="col-xs-12 col-md-8">
            <div class="field-types">
              <a href="javascript:;" class="btn" ng-repeat="type in form.addFieldTypes" ng-click="form.addField(section.i, $parent.$index+1, type)" scroll-to=".force-hover" template="form">
                <i class="glyphicon {{type.glyphicon}}"></i> {{type.value}}
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>