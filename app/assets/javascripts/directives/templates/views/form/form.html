<div ng-form="myForm">

  <div class="form-header" ng-if="!form.id || form.editing">

    <a href="javascript:;" ng-show="report.editing" class="text-danger close pull-right" ng-bootbox-confirm="<center><h4>Are you sure you want to remove this page from the report?<br><br>All information will be lost.</h4></center>" ng-bootbox-confirm-action="report.removeTemplate(form, report)">&times;</a>

    <div class="col-xs-12 col-md-2">
      <label for="form-name">Page Name</label>
      <input type="text" id="form-name" class="form-control" placeholder="Required" ng-model="form.name">
      <div ng-if="!form.id">Add a name, then save the page</div>
    </div>
    <div class="col-xs-12 col-md-2" ng-if="form.editing">
      <label for="new-section-name">New Section Name</label>
      <div class="input-group">
        <input type="text" id="new-section-name" class="form-control" placeholder="Optional" ng-model="form.newSectionName" />
        <span class="input-group-btn">
          <a href="javascript:;" class="btn btn-primary" ng-click="form.selectedOptions==form.newSectionName;form.addSection(form, form.newSectionName, myForm.$$parentForm)" scroll-to=".force-hover" template="form">Add</a>
        </span>
      </div>
    </div>
    <div class="col-xs-12 col-md-2" ng-if="form.editing" ng-click="field.draft = !field.draft;myForm.$$parentForm.$dirty=true">
      <label>Draft</label>
      <p>
        <span class="btn-group btn-group-justified">
          <a href="javascript:;" class="btn btn-default" ng-class="{'btn-primary':field.draft}">On</a>
          <a href="javascript:;" class="btn btn-default" ng-class="{'btn-primary':!field.draft}">Off</a>
        </span>
      </p>
    </div>

  </div>

  <div ng-if="report.hideTitle==false && report.allow_title==true" class="">
    <div class="col-xs-12">
      <input ng-if="!report.viewing" type="text" class="form-control imod" placeholder="Title" ng-model="report.title">
      <h1 ng-if="report.viewing" class="text-center">{{report.title}}</h1>
    </div>
  </div>

  <div class="col-xs-12 paper" ng-show="form.sections">

    <div class="col-xs-10 col-xs-offset-1 col-md-8 col-md-offset-2">
      <h1><center>{{form.name}}</center></h1>
    </div>

    <div class="col-xs-12" ng-class="{
    'col-md-4 col-md-offset-4':form.columns.indexOf(1) == 0 && form.columns.indexOf(2) < 0 && form.columns.indexOf(3) < 0, 
    'col-md-8 col-md-offset-2':form.columns.indexOf(2) == 0 && form.columns.indexOf(3) < 0, 
    'col-md-12':form.columns.indexOf(3) == 0}">

      <div class="section-row col-xs-12" ng-repeat="(section_id, section_name) in form.sections track by $index" ng-class="{'stay-open':!form.fields.length || form.selectedOptions.section_id == section_id+1 || form.selectedOptions == section_id}">

        <h2 ng-class="{'no-highlight':!form.editing}">
          {{(!form.editing && section_name) || null}}
          <input type="text" id="form-name" class="form-control imod" placeholder="Section name or blank" ng-if="form.editing" ng-model="form.sections[section_id]" ng-click="form.selectedOptions=section_id" />
        </h2>
        <div class="section-layout" ng-if="form.editing">
          <span class="col-xs-12">
            Reorder
            <a href="javascript:;" class="btn btn-primary" ng-click="form.moveSection(form, section_id, 'up');myForm.$$parentForm.$dirty=true" scroll-to=".force-hover" template="form"><i class="glyphicon glyphicon-arrow-up"></i></a>
            <a href="javascript:;" class="btn btn-primary" ng-click="form.moveSection(form, section_id, 'down');myForm.$$parentForm.$dirty=true" scroll-to=".force-hover" template="form"><i class="glyphicon glyphicon-arrow-down"></i></a>

            <div class="pull-right">
              <a href="javascript:;" class="btn btn-primary" ng-if="form.columns[section_id] > 1" ng-click="form.deleteSectionColumn(form, section_id, myForm.$$parentForm)"><i class="glyphicon glyphicon-minus"></i></a>
              <a href="javascript:;" class="btn btn-primary" ng-if="form.columns[section_id] < 3" ng-click="form.addSectionColumn(form, section_id, myForm.$$parentForm)"><i class="glyphicon glyphicon-plus"></i></a>
              Column
              <i class="glyphicon glyphicon-chevron-down"></i>
            </div>
          </span>
        </div>


        <div class="col-xs-12 column" ng-class="{'col-md-6':form.columns[section_id] == 2, 'col-md-4':form.columns[section_id] == 3}" ng-repeat="column in columnsArray(form.columns[section_id]) track by $index">

          <div ng-repeat="field in form.fields | filter:{column_id: $index+1, section_id: section_id+1} | orderBy:'column_order'">
            <template-field-directive ng-click="form.selectedOptions=field" myForm="myForm" field="field" template="form" report="report"></template-field-directive>

            <div class="field-options" ng-if="form.editing" ng-class="{'slide':form.selectedOptions==field}">
              <h4 class="col-xs-12">
                <strong><i class="glyphicon glyphicon-cog"></i> {{field.fieldtype|uppercase}} </strong><small>SETTINGS</small>
                <p class="pull-right">
                  <a href="javascript:;" class="btn-sm" ng-disabled="{{$first}}" ng-click="form.changeFieldColumn(form, field, field.column_id-1);myForm.$$parentForm.$dirty=true"><i class="glyphicon glyphicon-arrow-left"></i></a>
                  <a href="javascript:;" class="btn-sm" disabled="{{$first}}" ng-click="form.moveField(form, form.selectedOptions, 'up');myForm.$$parentForm.$dirty=true"><i class="glyphicon glyphicon-arrow-up"></i></a>
                  <a href="javascript:;" class="btn-sm" disabled="{{$last}}" ng-click="form.moveField(form, form.selectedOptions, 'down');myForm.$$parentForm.$dirty=true"><i class="glyphicon glyphicon-arrow-down"></i></a>
                  <a href="javascript:;" class="btn-sm" ng-disabled="field.column_id == column" ng-click="form.changeFieldColumn(form, field, field.column_id+1);myForm.$$parentForm.$dirty=true"><i class="glyphicon glyphicon-arrow-right"></i></a>
                </p>
              </h4>
              <div class="col-xs-6">
                <input type="text" class="form-control" placeholder="{{(field.fieldtype == 'labelntext' && 'Label') || 'Name'}}" ng-model="field.name">
                <input type="text" class="form-control" placeholder="{{(field.fieldtype == 'labelntext' && 'Text') || 'Default Value'}}" ng-model="field.default_value">
                <input type="text" class="form-control" placeholder="Placeholder" ng-model="field.placeholder">
                <input type="text" class="form-control" placeholder="Tooltip" ng-model="field.tooltip">
              </div>
              <div class="col-xs-6">
                <select class="form-control" ng-options="section_id*1+1 as section_name for (section_id, section_name) in form.sections" ng-model="field.section_id" ng-change="form.changeFieldSection(form, field, '{{field.section_id}}')"></select>
                <div class="btn-group btn-group-justified" ng-click="field.required = !field.required;myForm.$$parentForm.$dirty=true">
                  <a href="javascript:;" class="btn btn-default" ng-class="{'btn-primary':field.required}">Required</a>
                  <a href="javascript:;" class="btn btn-default" ng-class="{'btn-primary':!field.required}">OFF</a>
                </div>
                <div class="btn-group btn-group-justified" ng-click="field.disabled = !field.disabled;myForm.$$parentForm.$dirty=true">
                  <a href="javascript:;" class="btn btn-default" ng-class="{'btn-primary':field.disabled}">Disabled</a>
                  <a href="javascript:;" class="btn btn-default" ng-class="{'btn-primary':!field.disabled}">OFF</a>
                </div>
              </div>
            </div>
            <div class="clearfix" ng-if="form.editing && form.selectedOptions.id == field.id">
              <a href="javascript:;" class="close h4" ng-click="form.selectedOptions = undefined">Close</a>
            </div>
          </div>

          <div class="add-field-slide" ng-if="form.editing">
            <h4 class="col-xs-12">
              <i class="glyphicon glyphicon-chevron-up"></i> 
              <strong>New Field</strong> <small>{{section_name || 'Section '+(section_id*1+1)}}, Column {{$index+1}}</small>
            </h4>
            <div class="col-xs-12 col-md-4">
              <small>OPTIONAL</small>
              <input type="text" class="form-control" placeholder="Name" ng-model="form.newFieldName">
              <input type="text" class="form-control" placeholder="Placeholder" ng-model="form.newFieldPlaceholder">
            </div>
            <div class="col-xs-12 col-md-8">
              <small>TYPE</small>
              <p><a href="javascript:;" class="btn" ng-repeat="type in form.addFieldTypes" ng-click="form.addField(form, 1*section_id+1, $parent.$index+1, type, form.newFieldName, form.newFieldPlaceholder, myForm.$$parentForm);form.newFieldAdd=false" scroll-to=".force-hover" template="form">
                              <i class="glyphicon {{type.glyphicon}}"></i> {{type.value}}
                            </a></p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>