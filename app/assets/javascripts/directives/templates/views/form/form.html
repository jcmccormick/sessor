<draggable-options field="form.sO" form="form" class="field-options" ng-if="form.e && form.poppedOut && form.sO.fieldtype"></draggable-options>
<div ng-form="myForm">

  <div class="form-header" ng-if="!form.id || form.e">

    <a href="javascript:;" ng-show="report.editing" class="text-danger close pull-right" ng-bootbox-confirm="<center><h4>Are you sure you want to remove this page from the report?<br><br>All information will be lost.</h4></center>" ng-bootbox-confirm-action="report.removeTemplate(form, report)">&times;</a>

    <div class="col-xs-12 col-md-3">
      <label for="form-name">Page Name</label>
      <input type="text" id="form-name" class="form-control" placeholder="Required" ng-model="form.name" ng-keypress="($event.keyCode==13) && form.saveTemplate(true)" />
      <div ng-if="!form.id">Add a name, then press Enter</div>
    </div>
    <div ng-if="form.e">
      <div class="col-xs-6 col-md-3">
        <label for="new-section-name">New Section Name</label>
        <div class="input-group">
          <input type="text" id="new-section-name" class="form-control" placeholder="Optional" ng-model="form.newSectionName" />
          <span class="input-group-btn">
            <a href="javascript:;" class="btn btn-primary" ng-click="form.addSection(form.newSectionName)" scroll-to=".force-hover" template="form">Add</a>
          </span>
        </div>
      </div>
      <div class="col-xs-4 col-md-2">
        <label>Draft</label>
        <span class="btn-group btn-group-justified" ng-click="form.draft = !form.draft">
          <a href="javascript:;" class="btn btn-default" ng-class="{'btn-primary':form.draft}">On</a>
          <a href="javascript:;" class="btn btn-default" ng-class="{'btn-primary':!form.draft}">Off</a>
        </span>
      </div>
      <div class="col-xs-2 col-md-1">
        <div class="input-group">
          <label>Fields</label>
          <p>{{form.activeFields()}} / 20</p>
        </div>
      </div>
    </div>
  </div>

  <div ng-if="report.hideTitle==false && report.allow_title==true" class="">
    <div class="col-xs-12">
      <input ng-if="!report.viewing" type="text" class="form-control imod" placeholder="Title" ng-model="report.title">
      <h1 ng-if="report.viewing" class="text-center">{{report.title}}</h1>
    </div>
  </div>

  <div class="col-xs-12 paper" ng-class="{'gridline-workspace':form.e}" ng-show="form.sections">
    <small class="col-xs-12" ng-if="form.draft && !form.e"><strong>Draft</strong></small>
    <div ng-if="!form.e" class="col-xs-10 col-xs-offset-1 col-md-8 col-md-offset-2">
      <h1><center>{{form.name}}</center></h1>
    </div>

    <div class="section-row stay-open clearfix" ng-class="{'col-md-4 col-md-offset-4':section.c==1,'col-md-8 col-md-offset-2':section.c==2,'col-md-12':section.c==3}" ng-repeat="section in form.sections track by $index">
    <!-- ng-class="{'stay-open':!form.fields.length || form.sO.section_id == section_id+1 || form.sO == section_id}" -->

      <h2 ng-class="{'no-highlight':!form.e,'force-hover':form.sO==section,'field-hover':form.sO.section_id == section.i}" scroll-to=".force-hover" template="form">
        {{(!form.e && section.n) || null}}
        <input type="text" id="form-name" class="form-control imod" placeholder="Section name or blank" ng-if="form.e" ng-model="section.n" ng-click="form.sO=section" />
      </h2>

      <div class="section-layout" ng-if="form.e">
        <span class="col-xs-12">
          Reorder
          <a href="javascript:;" class="btn" ng-click="form.moveSection($index, $index-1)" scroll-to=".force-hover" template="form"><i class="glyphicon glyphicon-arrow-up"></i></a>
          <a href="javascript:;" class="btn" ng-click="form.moveSection($index, $index+1)" scroll-to=".force-hover" template="form"><i class="glyphicon glyphicon-arrow-down"></i></a>
          <div class="pull-right">
            <a href="javascript:;" class="btn" ng-if="section.c > 1" ng-click="form.deleteSectionColumn(section)"><i class="glyphicon glyphicon-minus"></i></a>
            <a href="javascript:;" class="btn" ng-if="section.c < 3" ng-click="form.addSectionColumn(section)"><i class="glyphicon glyphicon-plus"></i></a>
            Column
            <i class="glyphicon glyphicon-chevron-down"></i>
            <a href="javascript:;" class="save-now" ng-bootbox-confirm="<center><h4>Are you sure you want to remove this section from the page?<br><br>The section's columns and fields will also be deleted and this is not reversible.</h4></center>" ng-bootbox-confirm-action="form.deleteSection(section.i)">
              <i class="glyphicon glyphicon-remove"></i>
            </a>
          </div>

        </span>
      </div>


      <div class="col-xs-12 column" ng-class="{'col-md-6':section.c == 2, 'col-md-4':section.c == 3}" ng-repeat="column in columnsArray(section.c) track by $index">

        <div ng-repeat="field in form.fields | filter:{column_id: $index+1, section_id: section.i} | orderBy:'column_order'">
          <template-field-directive ng-click="form.sO=field" myForm="myForm" field="field" template="form" report="report"></template-field-directive>

          <draggable-options field="field" form="form" class="field-options" ng-if="form.e && !form.poppedOut && form.sO==field" ng-class="{'slide':form.sO==field}"></draggable-options>
          
        </div>

        <div class="add-field-slide" ng-if="form.e && form.activeFields() < 20">
          <h4 class="col-xs-12">
            <i class="glyphicon glyphicon-chevron-up"></i> 
            <strong>New Field</strong> <small>{{section.n || 'Section '+(section.i)}}, Column {{$index+1}}</small>
          </h4>
          <div class="col-xs-12 col-md-4">
            <input type="text" class="form-control" placeholder="Name" ng-model="form.newFieldName">
            <input type="text" class="form-control" placeholder="Placeholder" ng-model="form.newFieldPlaceholder">
            <small>&nbsp; At least 1 required</small>
          </div>
          <div class="col-xs-12 col-md-8">
            <div class="field-types">
              <a href="javascript:;" class="btn" ng-repeat="type in form.addFieldTypes" ng-click="form.addField(section.i, $parent.$index+1, type)" scroll-to=".force-hover" template="form">
                <i class="glyphicon {{type.glyphicon}}"></i> {{type.value}}
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>